<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Scholarships</title>

    <!-- Scripts for Firebase -->
    <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-analytics.js"></script>

    <!--Style sources-->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/scholarships.css">
    <link rel="stylesheet" href="css/style.css">

</head>

<body>

    <!-- NAVBAR -->
    <div class="w3-top">
      <div class="w3-bar w3-theme-d5 w3-card">
        <a class="w3-bar-item w3-button w3-padding-large w3-hide-medium w3-hide-large w3-right" href="javascript:void(0)" onclick="myFunction()" title="Toggle Navigation Menu"><i class="fa fa-bars"></i></a>
        <p style="text-align:center">Scholarships.co </p>

        <a href="index.html" class="w3-bar-item w3-button w3-padding-large">Home</a>
        <a href="scholarships.html" class="w3-bar-item w3-button w3-padding-large w3-hide-small">Scholarships</a>
        <div class="w3-dropdown-hover w3-hide-small">
          <button class="w3-padding-large w3-button" title="More">My Account <i class="fa fa-caret-down"></i></button>     
          <div class="w3-dropdown-content w3-bar-block w3-card-4">
            <a href="account.html" class="w3-bar-item w3-button">View Account</a>
            <!--logout action**-->
            <a href="#" class="w3-bar-item w3-button">Logout</a>
          </div>
        </div>
        <a href="javascript:void(0)" class="w3-padding-large w3-theme-d5 w3-hide-small w3-right"><i class="fa fa-search"></i></a>
      </div>
    </div>

    <!-- USER INFORMATION AND LOGOUT -->
    <nav>
        <span>
      <svg class="bi bi-person-fill" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/></svg>
      <b>User:</b> <span id="emailDisplay"></span>&nbsp;
        <button id="btnLogout" class="btn btn-action">Log Out</button>
        <br>
        <b>GPA:</b> <span id="gpaDisplay"></span>&nbsp;&nbsp;
        <b>Degree:</b> <span id="majorDisplay"></span> / <span id="minorDisplay"></span>&nbsp;&nbsp;
        <b>Graduate Type:</b> <span id="gradDisplay"></span></span>&nbsp;
        </span>
    </nav>

    <!-- Scholarships -->
    <div class="w3-container" id="about-us" style="margin-top:75px">
        <h1 class="w3-xxxlarge w3-text-d4"><b>Scholarships</b></h1>
        <hr style="width:50px;border:5px solid #456f93" class="w3-round">
    </div>

    <script>
        /**
         * Checks to see if student's degree matches scholarship's eligible degrees
         */
        function checkIfDegreeValid(scholarship, student) {
            if (scholarship.degrees.includes(student.degree.major) || scholarship.degrees.includes(student.degree.minor)) { // Gets warning if student's minor is undefined
                return true;
            } else {
                return false; // Probably don't need to return false
            }
        }

        /**
         * Checks to see if student's GPA is at least that of the scholarship's minimum GPA requirement
         */
        function checkIfGPAValid(scholarship, student) {
            if (parseFloat(scholarship.gpaRequired) <= parseFloat(student.gpa)) {
                return true;
            } else {
                return false;
            }
        }

        /**
         * When a user presses "Apply", this function will be called which checks to see if the user has
         * 1. An eligible degree for the scholarship applied for
         * 2. The minimum GPA required for the scholarship
         * TODO: 3. The eligible graduate type for the scholarship
         */
        function checkIfScholarshipValid(scholarshipId) {
            // Check if user is logged in first
            firebase.auth().onAuthStateChanged(firebaseUser => {
                if (firebaseUser) {
                    // Get reference for student from database
                    let ref = firebase.database().ref('/Users/Student/' + firebaseUser.uid);
                    // Get student object
                    ref.on('value', function(studentSnapshot) {
                        // Get reference for scholarship from database
                        let scholarshipRef = firebase.database().ref('/Scholarships/' + scholarshipId);
                        // Get scholarship object
                        scholarshipRef.on('value', function(scholarshipSnapshot) {
                            let scholarship = scholarshipSnapshot.val();
                            let student = studentSnapshot.val();
                            // Check if student has valid degree and GPA for scholarship
                            if (checkIfDegreeValid(scholarship, student) && checkIfGPAValid(scholarship, student)) {
                                console.log("Student has appropriate major/minor and GPA for scholarship.");
                                // Redirect user to apply page
                                window.location = "application.html";
                            } else {
                                alert("Invalid degree or GPA not high enough.")
                            }
                        })
                    })
                } else {
                    console.log('Error getting user ID');
                }
            });
        }

        /**
         * Gets scholarships and appends their data to webpage
         */
        function getData() {
            firebase.database().ref('/Scholarships').once('value', function(snapshot) {
                snapshot.forEach(function(childSnapshot) {
                    let childKey = childSnapshot.key;
                    let childData = childSnapshot.val();
                    console.log(childKey, childData);

                    let tmp = '';
                    tmp += '<div class="col-md-4 col-sm-4">';
                    tmp += '    <div class="scholarship-info">';
                    tmp += '      <h3><svg class="bi bi-award" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.669.864L8 0 6.331.864l-1.858.282-.842 1.68-1.337 1.32L2.6 6l-.306 1.854 1.337 1.32.842 1.68 1.858.282L8 12l1.669-.864 1.858-.282.842-1.68 1.337-1.32L13.4 6l.306-1.854-1.337-1.32-.842-1.68L9.669.864zm1.196 1.193l-1.51-.229L8 1.126l-1.355.702-1.51.229-.684 1.365-1.086 1.072L3.614 6l-.25 1.506 1.087 1.072.684 1.365 1.51.229L8 10.874l1.356-.702 1.509-.229.684-1.365 1.086-1.072L12.387 6l.248-1.506-1.086-1.072-.684-1.365z" clip-rule="evenodd"/><path d="M4 11.794V16l4-1 4 1v-4.206l-2.018.306L8 13.126 6.018 12.1 4 11.794z"/></svg> ' + childData['name'] + '</h3>';
                    tmp += '      <p><i id="ic" class="fa fa-usd" aria-hidden="true"></i> <b>Amount:</b> $' + childData['amount'] + '</p>';
                    tmp += '      <p><i id="ic" class="fa fa-graduation-cap" aria-hidden="true"></i> <b>Minimum GPA:</b> ' + childData['gpaRequired'] + '</p>';
                    tmp += '      <p><i id="ic" class="fa fa-calendar-o" aria-hidden="true"></i> <b>Deadline:</b> ' + childData['deadline'] + '</p>';
                    tmp += '      <p><i id="ic" class="fa fa-list"></i> <b>Degrees Eligible:</b> ' + childData['degrees'].join(', ').toUpperCase() + '</p>';
                    tmp += '      <p><i id="ic" class="fa fa-file-text-o" aria-hidden="true"></i> <b>Description:</b> ' + childData['description'] + '</p>';
                    tmp += '      <button type="button" id="' + childKey + '" onclick="checkIfScholarshipValid(\'' + childKey + '\')" class="btn btn-primary">Apply</button>'
                    tmp += '    </div>';
                    tmp += '</div>';
                    $('#main').prepend(tmp);
                })
            })
        }

        getData();

        firebase.auth().onAuthStateChanged(firebaseUser => {
            if (firebaseUser) {
                document.getElementById("emailDisplay").innerHTML = firebaseUser.email;
                // Get reference for student from database
                let ref = firebase.database().ref('/Users/Student/' + firebaseUser.uid);
                // Get student object
                ref.on('value', function(studentSnapshot) {
                    let student = studentSnapshot.val();
                    document.getElementById("gpaDisplay").innerHTML = student.gpa;
                    document.getElementById("majorDisplay").innerHTML = student.degree.major.toUpperCase();
                    document.getElementById("minorDisplay").innerHTML = student.degree.minor.toUpperCase();
                    document.getElementById("gradDisplay").innerHTML = student.graduateType;
                })
                document.getElementById("emailDisplay").innerHTML = firebaseUser.email;
            } else {
                window.location = "login.html";
                console.log('Not logged in')
            }
        });
    </script>

</body>

</html>
